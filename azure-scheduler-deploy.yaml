# Azure Container Apps Configuration for Meeting Bot Scheduler
# Deploy with: az containerapp create --yaml azure-scheduler-deploy.yaml

properties:
  managedEnvironmentId: /subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/Microsoft.App/managedEnvironments/{environment-name}
  configuration:
    activeRevisionsMode: Single
    ingress:
      external: true
      targetPort: 8080
      transport: auto
      allowInsecure: false
      traffic:
        - weight: 100
          latestRevision: true
      corsPolicy:
        allowedOrigins:
          - "*"
        allowedMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        allowedHeaders:
          - "*"
    secrets:
      - name: azure-resource-group
        value: "{your-resource-group}"
      - name: azure-job-name
        value: "{your-container-job-name}"
      - name: azure-location
        value: "{azure-region}"
    registries:
      - server: {your-acr}.azurecr.io
        username: {acr-username}
        passwordSecretRef: acr-password
  template:
    containers:
      - image: {your-acr}.azurecr.io/meet-teams-bot-scheduler:latest
        name: scheduler
        resources:
          cpu: 0.5
          memory: 1Gi
        env:
          - name: NODE_ENV
            value: production
          - name: PORT
            value: "8080"
          - name: PLATFORM
            value: azure
          - name: SCHEDULER_MAX_CONCURRENT_JOBS
            value: "100"
          - name: SCHEDULER_CONTAINER_IMAGE
            value: "{your-acr}.azurecr.io/meet-teams-bot:latest"
          - name: AZURE_RESOURCE_GROUP
            secretRef: azure-resource-group
          - name: AZURE_JOB_NAME
            secretRef: azure-job-name
          - name: AZURE_LOCATION
            secretRef: azure-location
    scale:
      minReplicas: 1
      maxReplicas: 10
      rules:
        - name: http-scaling
          http:
            metadata:
              concurrentRequests: "50"
